name: Automated PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  automated-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Run architecture analysis
        id: architecture-analysis
        run: |
          npm run review:architecture
        continue-on-error: true

      - name: Run Danger.js for PR review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx danger ci

      - name: Check test coverage
        run: |
          npm test -- --coverage
          npx nyc report --reporter=text
        continue-on-error: true

      - name: Comment PR with review summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read analysis results
            let comment = '## Automated Code Review Results\n\n';

            if (fs.existsSync('architecture-violations.md')) {
              const violations = fs.readFileSync('architecture-violations.md', 'utf8');
              comment += violations;
            } else {
              comment += 'âœ… No architecture violations detected!\n';
            }

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
