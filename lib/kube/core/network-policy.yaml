---
# Default deny-all ingress policy - blocks all incoming traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: $KUBE_NS
spec:
  podSelector: {}  # Applies to all pods in this namespace
  policyTypes:
    - Ingress

---
# Default deny-all egress policy - blocks all outgoing traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: $KUBE_NS
spec:
  podSelector: {}  # Applies to all pods in this namespace
  policyTypes:
    - Egress

---
# Application traffic policy - allows specific ingress and egress for app pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-app-traffic
  namespace: $KUBE_NS
spec:
  podSelector:
    matchLabels:
      component: $KUBE_NS  # Targets application pods only
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from nginx ingress controller only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080  # Application service port
  egress:
    # Allow DNS resolution to kube-system namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow HTTPS connections to external services
    # WARNING: This allows ALL external HTTPS traffic
    # TODO: Restrict to specific external service IPs/domains for production
    - to: []
      ports:
        - protocol: TCP
          port: 443

    # Allow MongoDB database connections
    # TODO: Restrict to specific MongoDB server IPs for production
    - to: []
      ports:
        - protocol: TCP
          port: 27017

    # Allow syslog connections for centralized logging (Papertrail)
    # TODO: Restrict to specific logging service IPs for production
    - to: []
      ports:
        - protocol: UDP
          port: 514
        - protocol: TCP
          port: 514

---
# ACME HTTP-01 challenge policy - required for SSL certificate generation
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-acme-solver
  namespace: $KUBE_NS
spec:
  podSelector:
    matchLabels:
      acme.cert-manager.io/http01-solver: "true"  # Targets cert-manager ACME solver pods
  policyTypes:
    - Ingress
  ingress:
    # Allow nginx ingress controller to reach ACME challenge endpoints
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8089  # ACME HTTP-01 challenge port
