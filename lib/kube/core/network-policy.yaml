---
# Default deny-all ingress policy - blocks all incoming traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: $KUBE_NS
spec:
  podSelector: {}  # Applies to all pods in this namespace
  policyTypes:
    - Ingress

---
# Default deny-all egress policy - blocks all outgoing traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: $KUBE_NS
spec:
  podSelector: {}  # Applies to all pods in this namespace
  policyTypes:
    - Egress

---
# Application traffic policy - allows specific ingress and egress for app pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-app-traffic
  namespace: $KUBE_NS
spec:
  podSelector:
    matchLabels:
      component: $KUBE_NS  # Targets application pods only
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from nginx ingress controller only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080  # Application service port
  egress:
    # Allow DNS resolution to kube-system namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow HTTPS to MongoDB Atlas (production-ready IP restrictions)
    - to:
        # MongoDB Atlas AWS IP ranges
        - ipBlock:
            cidr: 3.0.0.0/8
        - ipBlock:
            cidr: 13.0.0.0/8
        - ipBlock:
            cidr: 52.0.0.0/8
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 27017

    # Allow connections to Papertrail logging service (specific IPs only)
    - to:
        - ipBlock:
            cidr: 169.46.82.162/32  # Papertrail IP 1
        - ipBlock:
            cidr: 169.46.82.163/32  # Papertrail IP 2
        - ipBlock:
            cidr: 169.46.82.164/32  # Papertrail IP 3
        - ipBlock:
            cidr: 169.46.82.165/32  # Papertrail IP 4
      ports:
        - protocol: UDP
          port: 514
        - protocol: TCP
          port: 514

    # Allow HTTPS to essential CDNs and APIs (restricted IP ranges)
    - to:
        # Cloudflare CDN
        - ipBlock:
            cidr: 104.16.0.0/12
        # AWS CloudFront CDN
        - ipBlock:
            cidr: 54.230.0.0/16
        # Google APIs
        - ipBlock:
            cidr: 142.250.0.0/15
      ports:
        - protocol: TCP
          port: 443

---
# ACME HTTP-01 challenge policy - required for SSL certificate generation
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-acme-solver
  namespace: $KUBE_NS
spec:
  podSelector:
    matchLabels:
      acme.cert-manager.io/http01-solver: "true"  # Targets cert-manager ACME solver pods
  policyTypes:
    - Ingress
  ingress:
    # Allow nginx ingress controller to reach ACME challenge endpoints
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
          podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8089  # ACME HTTP-01 challenge port
